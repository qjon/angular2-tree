!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@ngrx/store"),require("rxjs/Observable"),require("rxjs/operators"),require("rxjs/add/observable/combineLatest"),require("rxjs/add/operator/do"),require("lodash.isequal"),require("@angular/forms"),require("ngx-contextmenu"),require("@ngrx/effects"),require("@angular/animations"),require("rxjs/Subscription"),require("rxjs/add/observable/empty"),require("rxjs/Subject"),require("rxjs/BehaviorSubject"),require("rxjs/add/operator/withLatestFrom"),require("rxjs/add/observable/merge"),require("@angular/common/http"),require("rxjs/add/observable/of"),require("@angular/common"),require("ng2-dnd"),require("ng2-translate")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@ngrx/store","rxjs/Observable","rxjs/operators","rxjs/add/observable/combineLatest","rxjs/add/operator/do","lodash.isequal","@angular/forms","ngx-contextmenu","@ngrx/effects","@angular/animations","rxjs/Subscription","rxjs/add/observable/empty","rxjs/Subject","rxjs/BehaviorSubject","rxjs/add/operator/withLatestFrom","rxjs/add/observable/merge","@angular/common/http","rxjs/add/observable/of","@angular/common","ng2-dnd","ng2-translate"],t):t(e.angular2tree={},e.ng.angular.core,e.ng.ngrx.store,e.Observable,e.operators,null,null,e.isEqual,e.ng.angular.forms,e.ngxContextmenu,e.ng.ngrx.effects,e.ng.angular.animations,e.Subscription,null,e.Subject,e.BehaviorSubject,null,null,e.ng.angular["common-http"],null,e.ng.angular.common,e.ng["ng2-dnd"],e.ng["ng2-translate"])}(this,function(e,t,n,o,r,i,a,d,s,p,c,l,u,E,f,h,y,g,_,m,N,D,v){"use strict";var T=function(){function e(){}return e.prototype.registerTree=function(t,n,o){return void 0===n&&(n=!1),void 0===o&&(o=[]),{type:e.TREE_REGISTER,payload:{treeId:t,silent:n,nodes:o}}},e.prototype.editNodeStart=function(t){return{type:e.TREE_EDIT_NODE_START,payload:{node:t,treeId:t.treeId}}},e.prototype.saveNode=function(t,n){return{type:e.TREE_SAVE_NODE,payload:{treeId:t,node:n}}},e.prototype.saveNodeSuccess=function(t,n,o){return{type:e.TREE_SAVE_NODE_SUCCESS,payload:{treeId:t,oldNode:n,node:o}}},e.prototype.saveNodeError=function(t,n){return{type:e.TREE_SAVE_NODE_ERROR,payload:{treeId:t,node:n}}},e.prototype.deleteNode=function(t,n){return{type:e.TREE_DELETE_NODE,payload:{treeId:t,node:n}}},e.prototype.collapseNode=function(t,n){return{type:e.TREE_COLLAPSE_NODE,payload:{treeId:t,id:n}}},e.prototype.expandNode=function(t,n){return{type:e.TREE_EXPAND_NODE,payload:{treeId:t,id:n}}},e.prototype.deleteNodeSuccess=function(t,n){return{type:e.TREE_DELETE_NODE_SUCCESS,payload:{treeId:t,node:n}}},e.prototype.deleteNodeError=function(t,n){return{type:e.TREE_DELETE_NODE_ERROR,payload:{treeId:t,node:n}}},e.prototype.insertNode=function(t,n){return{type:e.TREE_INSERT_NODE,payload:{treeId:t,id:n}}},e.prototype.loadTree=function(t,n){return{type:e.TREE_LOAD,payload:{treeId:t,id:n}}},e.prototype.loadTreeSuccess=function(t,n,o){return{type:e.TREE_LOAD_SUCCESS,payload:{treeId:t,id:n,nodes:o}}},e.prototype.loadTreeError=function(t,n){return{type:e.TREE_LOAD_ERROR,payload:{treeId:t,id:n}}},e.prototype.markAsFullyLoaded=function(t){return{type:e.TREE_MARK_AS_FULLY_LOADED,payload:{treeId:t}}},e.prototype.moveNode=function(t,n,o,r){return{type:e.TREE_MOVE_NODE,payload:{sourceOfDroppedData:t,treeId:n,oldNode:o,node:r}}},e.prototype.moveNodeSuccess=function(t,n,o){return{type:e.TREE_MOVE_NODE_SUCCESS,payload:{treeId:t,source:n,target:o}}},e.prototype.moveNodeError=function(t,n,o){return{type:e.TREE_MOVE_NODE_ERROR,payload:{treeId:t,source:n,target:o}}},e.prototype.setAllNodes=function(t,n){return{type:e.TREE_SET_ALL_NODES,payload:{treeId:t,nodes:n}}},e.prototype.setConfiguration=function(t,n){return{type:e.TREE_SET_CONFIGURATION,payload:{treeId:t,configuration:n}}},e.prototype.loadPath=function(t,n){return{type:e.TREE_LOAD_PATH,payload:{treeId:t,ids:n}}},e.prototype.selectNode=function(t,n){return{type:e.TREE_SELECT_NODE,payload:{node:n,treeId:t}}},e.TREE_SAVE_NODE="TREE_SAVE_NODE",e.TREE_SAVE_NODE_SUCCESS="TREE_SAVE_NODE_SUCCESS",e.TREE_SAVE_NODE_ERROR="TREE_SAVE_NODE_ERROR",e.TREE_DELETE_NODE="TREE_DELETE_NODE",e.TREE_DELETE_NODE_SUCCESS="TREE_DELETE_NODE_SUCCESS",e.TREE_DELETE_NODE_ERROR="TREE_DELETE_NODE_ERROR",e.TREE_EDIT_NODE_START="TREE_EDIT_NODE_START",e.TREE_COLLAPSE_NODE="TREE_COLLAPSE_NODE",e.TREE_EXPAND_NODE="TREE_EXPAND_NODE",e.TREE_INSERT_NODE="TREE_INSERT_NODE",e.TREE_LOAD="TREE_LOAD",e.TREE_LOAD_PATH="TREE_LOAD_PATH",e.TREE_LOAD_SUCCESS="TREE_LOAD_SUCCESS",e.TREE_LOAD_ERROR="TREE_LOAD_ERROR",e.TREE_MARK_AS_FULLY_LOADED="TREE_MARK_AS_FULLY_LOADED",e.TREE_MOVE_NODE="TREE_MOVE_NODE",e.TREE_MOVE_NODE_SUCCESS="TREE_MOVE_NODE_SUCCESS",e.TREE_MOVE_NODE_ERROR="TREE_MOVE_NODE_ERROR",e.TREE_REGISTER="TREE_REGISTER",e.TREE_SELECT_NODE="TREE_SELECT_NODE",e.TREE_SET_ALL_NODES="TREE_SET_ALL_NODES",e.TREE_SET_CONFIGURATION="TREE_SET_CONFIGURATION",e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[]},e}(),S=this&&this.__assign||Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},I="ri-new-node-id",R={nodes:{entities:{},selected:null,rootNodes:[]},configuration:{isFullyLoaded:!1}};function O(e,t){void 0===t&&(t=null);var n=S({},e);return t&&(n[t]={nodes:{entities:S({},e[t].nodes.entities),selected:e[t].nodes.selected,rootNodes:e[t].nodes.rootNodes.slice()},configuration:S({},e[t].configuration)}),n}function A(e,t){var n=O(e,t.payload.treeId),o=t.payload.treeId,r=t.payload.nodes,i={};r.map(function(e){return e.id});return r.forEach(function(e){e.treeId=o,i[e.id]=e,null===e.parentId&&n[o].nodes.rootNodes.push(e.id)}),n[o].nodes.rootNodes.forEach(function(e){return function e(t,n,o){void 0===o&&(o=[]);var r=t[n];if(r&&(r.parents=o.slice(),r.children.length>0)){var i=o.concat([r.id]);r.children.forEach(function(n){return e(t,n,i)})}}(i,e)}),n[o].nodes.entities=i,n}function b(e,t){switch(void 0===e&&(e={}),t.type){case T.TREE_REGISTER:return V=t,(B=O(e))[V.payload.treeId]={nodes:{entities:S({},R.nodes.entities),selected:R.nodes.selected,rootNodes:R.nodes.rootNodes.slice()},configuration:S({},R.configuration)},B;case T.TREE_SAVE_NODE_SUCCESS:return function(e,t){var n=O(e,t.payload.treeId),o=t.payload.oldNode,r=t.payload.node,i=t.payload.treeId,a=n[i].nodes.entities;a[I]?delete a[I]:delete a[o.id];var d=r.id;a[d]=r;var s=r.parentId,p=a[s]||null;return s?p&&(p.children||(p.children=[]),p.children.push(d),r.parents=p.parents.concat([p.id])):o.id===I&&(n[i].nodes.rootNodes=n[i].nodes.rootNodes.filter(function(e){return e!==I}),n[i].nodes.rootNodes.push(d)),n}(e,t);case T.TREE_DELETE_NODE_SUCCESS:return function(e,t){var n=O(e,t.payload.treeId),o=n[t.payload.treeId],r=t.payload.node,i=r.parentId;if(delete o.nodes.entities[r.id],i){var a=S({},o.nodes.entities[i]);a.children=a.children.filter(function(e){return e!==r.id}),o.nodes.entities[i]=a}else o.nodes.rootNodes=o.nodes.rootNodes.filter(function(e){return e!==r.id});return n}(e,t);case T.TREE_INSERT_NODE:return $=e,w=(j=t).payload.treeId,F=O($,w),k=j.payload.id,U={id:I,treeId:w,name:"New data",parentId:k,children:[],parents:[],isExpanded:!1},F[w].nodes.entities[I]=U,k||(F[w].nodes.rootNodes=F[w].nodes.rootNodes.concat([I])),F;case T.TREE_LOAD_SUCCESS:return M=O(e,(C=t).payload.treeId),x=null,L=C.payload.treeId,(P=C.payload.id)?(x=M[L].nodes.entities[P]).children=[]:M[L].nodes.entities={},C.payload.nodes.forEach(function(e){e.treeId=L,x?(x.children.push(e.id),e.parents=x.parents.concat([x.id])):e.parents=[],M[L].nodes.entities[e.id]=e,P||M[L].nodes.rootNodes.push(e.id)}),M;case T.TREE_MOVE_NODE_SUCCESS:return function(e,t){var n=O(e,t.payload.treeId),o=t.payload.source,r=t.payload.target,i=t.payload.treeId,a=n[i],d=n[i].nodes.entities;if(o.parentId?d[o.parentId].children=d[o.parentId].children.filter(function(e){return e!==o.id}):a.nodes.rootNodes=a.nodes.rootNodes.filter(function(e){return e!==o.id}),r.parentId){var s=d[r.parentId];s.children&&s.children.push(r.id),r.parents=s.parents.concat([s.id])}else a.nodes.rootNodes.push(r.id),r.parents=[];return d[r.id]=S({},r),n}(e,t);case T.TREE_SET_ALL_NODES:return A(e,t);case T.TREE_MARK_AS_FULLY_LOADED:return D=e,v=t.payload.treeId,(b=O(D,v))[v].configuration=S({},b[v].configuration,{isFullyLoaded:!0}),b;case T.TREE_SET_CONFIGURATION:return g=e,m=(_=t).payload.treeId,(N=O(g,m))[m].configuration=S({},N[m].configuration,_.payload.configuration),N;case T.TREE_EXPAND_NODE:return u=e,f=(E=t).payload.treeId,h=O(u,f),y=E.payload.id,h[f].nodes.entities[y]=Object.assign({},h[f].nodes.entities[y],{isExpanded:!0}),h;case T.TREE_COLLAPSE_NODE:return d=e,p=(s=t).payload.treeId,c=O(d,p),l=s.payload.id,c[p].nodes.entities[l]=S({},c[p].nodes.entities[l],{isExpanded:!1}),c;case T.TREE_SELECT_NODE:return n=e,r=(o=t).payload.treeId,i=o.payload.node,(a=O(n,r))[r].nodes.selected=i?i.id:null,a;case T.TREE_DELETE_NODE:case T.TREE_EDIT_NODE_START:case T.TREE_LOAD:case T.TREE_MOVE_NODE:case T.TREE_SAVE_NODE:default:return e}var n,o,r,i,a,d,s,p,c,l,u,E,f,h,y,g,_,m,N,D,v,b,C,M,x,L,P,$,j,w,F,k,U,V,B}var C=n.createFeatureSelector("trees");function M(e){return n.createSelector(C,function(t){return t[e]||null})}function x(e){return n.createSelector(C,function(t){return t[e].configuration||null})}var L=d,P=function(){function e(e,t,n,o){void 0===o&&(o=!1);var i=this;this.treeActionDispatcher=e,this.treeData$=t,this.configuration=n,this._fullyLoaded=o,this.nodes$=this.treeData$.pipe(r.distinctUntilChanged(function(e,t){return L(e.nodes.entities,t.nodes.entities)}),r.map(function(e){return e.nodes.entities})),this.rootNodes$=this.treeData$.pipe(r.map(function(e){return e.nodes.rootNodes.map(function(t){return e.nodes.entities[t]}).sort(i.sortNodes)}),r.distinctUntilChanged()),this.currentSelectedNode$=this.treeData$.pipe(r.map(function(e){var t=e.nodes,n=t.selected;return n?t.entities[n]:null})),this.initConfiguration()}return Object.defineProperty(e.prototype,"treeId",{get:function(){return this.configuration.treeId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isFullyLoaded",{get:function(){return this._fullyLoaded},enumerable:!0,configurable:!0}),e.prototype.getParentsList=function(){return o.Observable.combineLatest(this.currentSelectedNode$,this.nodes$).pipe(r.map(function(e){var t=e[0],n=e[1];if(!Boolean(t))return[];var o=t.parents.map(function(e){return n[e]});return o.push(t),o}))},e.prototype.getChildren=function(e){var t=this;return this.nodes$.pipe(r.map(function(n){return t.getNodesByParentId(n,e)}),r.map(function(e){return e.slice().sort(t.sortNodes)}))},e.prototype.initPath=function(e){this.treeActionDispatcher.loadPath(this.configuration.treeId,e)},e.prototype.initConfiguration=function(){var e={disableMoveNodes:!1,dragZone:null,dropZone:null,treeId:"tree",showAddButton:!0,isAnimation:!1};for(var t in e)void 0===this.configuration[t]&&(this.configuration[t]=e[t])},e.prototype.getNodesByParentId=function(e,t){return Object.keys(e).filter(function(n){return e[n].parentId===t}).map(function(t){return e[t]})},e.prototype.sortNodes=function(e,t){return t.id===I?-1:e.name>t.name?1:-1},e}(),$=function(){function e(e,t){this.actions=e,this.store=t}return e.prototype.collapseNode=function(e,t){this.store.dispatch(this.actions.collapseNode(e,t))},e.prototype.deleteNode=function(e,t){this.store.dispatch(this.actions.deleteNode(e,t))},e.prototype.editNodeStart=function(e){this.store.dispatch(this.actions.editNodeStart(e))},e.prototype.expandNode=function(e,t){this.store.dispatch(this.actions.expandNode(e,t))},e.prototype.loadPath=function(e,t){this.store.dispatch(this.actions.loadPath(e,t))},e.prototype.loadTree=function(e,t){this.store.dispatch(this.actions.loadTree(e,t))},e.prototype.markAsFullyLoaded=function(e){this.store.dispatch(this.actions.markAsFullyLoaded(e))},e.prototype.registerTree=function(e,t,n){void 0===t&&(t=!1),this.store.dispatch(this.actions.registerTree(e,t,n))},e.prototype.saveNode=function(e,t){this.store.dispatch(this.actions.saveNode(e,t))},e.prototype.setConfiguration=function(e,t){this.store.dispatch(this.actions.setConfiguration(e,t))},e.prototype.selectNode=function(e,t){this.store.dispatch(this.actions.selectNode(e,t))},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:T},{type:n.Store}]},e}();function j(){return l.trigger("isExpanded",[l.state("inactive",l.style({height:0,opacity:0,transform:"scaleY(0)"})),l.state("active",l.style({transform:"scaleY(1)"})),l.transition("inactive => active",l.animate("300ms")),l.transition("active => inactive",l.animate("300ms"))])}var w=function(){function e(e,t,n){this.treeActionsDispatcherService=e,this.contextMenuService=t,this.actions$=n,this.nameField=new s.FormControl,this.isEditMode=!1,this.isSelected=!1,this.isExpanded=!1,this.animationState=null,this.children$=o.Observable.empty(),this.isStartSave=!1,this.subscription=new u.Subscription}return Object.defineProperty(e.prototype,"node",{get:function(){return this._node},set:function(e){this._node=e,this.initEditModeIfNeeded(e)},enumerable:!0,configurable:!0}),e.prototype.ngOnChanges=function(e){var t=e.node;t&&!t.firstChange&&t.previousValue.id!==t.currentValue.id&&(this.children$=this.treeModel.getChildren(this.node.id),this.node.isExpanded?this.markNodeAsExpanded():this.markNodeAsCollapsed())},e.prototype.ngOnDestroy=function(){this.subscription.unsubscribe()},e.prototype.ngOnInit=function(){var e=this;this.markNodeAsCollapsed(),this.children$=this.treeModel.getChildren(this.node.id),this.node.isExpanded&&this.markNodeAsExpanded(),this.subscription.add(this.treeModel.currentSelectedNode$.pipe(r.map(function(e){return e?e.id:null}),r.distinctUntilChanged()).subscribe(function(t){return e.isSelected=t===e.node.id})),this.subscription.add(this.getSubscriptionToExpandNode()),this.subscription.add(this.getSubscriptionToCollapseNode()),this.subscription.add(this.actions$.ofType(T.TREE_EDIT_NODE_START).pipe(r.filter(function(t){return t.payload.node===e.node})).subscribe(function(t){e.nameField.setValue(e.node.name),e.isEditMode=!0,e.setFocus()}))},e.prototype.collapse=function(){this.treeActionsDispatcherService.collapseNode(this.treeModel.treeId,this.node.id)},e.prototype.expand=function(){this.treeActionsDispatcherService.expandNode(this.treeModel.treeId,this.node.id),this.treeModel.isFullyLoaded||this.treeActionsDispatcherService.loadTree(this.treeModel.treeId,this.node.id)},e.prototype.onAnimationDone=function(e){"inactive"===e.toState&&(this.isExpanded=!1)},e.prototype.onBlur=function(){this.isStartSave?this.isStartSave=!1:this.undoChanges()},e.prototype.onChange=function(e){if(e.stopPropagation(),27===e.keyCode)this.undoChanges();else if(13===e.keyCode){this.isStartSave=!0;var t={id:this.node.id,treeId:this.node.treeId,name:this.nameField.value,parentId:this.node.parentId,children:this.node.children,parents:this.node.parents,isExpanded:!1};this.treeActionsDispatcherService.saveNode(this.treeModel.treeId,t),this.isEditMode=!1}},e.prototype.onContextMenu=function(e){this.treeModel.configuration.disableContextMenu||this.contextMenuService.show.next({contextMenu:this.contextMenu,event:e,item:this.node}),e.preventDefault(),e.stopPropagation()},e.prototype.onSelect=function(){this.isSelected?this.treeActionsDispatcherService.selectNode(this.treeModel.treeId,null):this.treeActionsDispatcherService.selectNode(this.treeModel.treeId,this.node)},e.prototype.isNewNode=function(){return this.node.id===I},e.prototype.setFocus=function(){var e=this;setTimeout(function(){return e.input.nativeElement.focus()},0)},e.prototype.undoChanges=function(){this.isEditMode=!1,this.isNewNode()&&this.treeActionsDispatcherService.deleteNode(this.treeModel.treeId,this.node)},e.prototype.markNodeAsExpanded=function(){this.treeModel.configuration.isAnimation&&(this.animationState="active"),this.isExpanded=!0},e.prototype.markNodeAsCollapsed=function(){this.treeModel.configuration.isAnimation?this.animationState="inactive":this.isExpanded=!1},e.prototype.getSubscriptionToExpandNode=function(){var e=this;return this.actions$.ofType(T.TREE_EXPAND_NODE).pipe(r.filter(function(t){return!e.isExpanded&&t.payload.treeId===e.treeModel.treeId&&e.node.id===t.payload.id})).subscribe(function(){e.markNodeAsExpanded(),e.isExpanded=!0})},e.prototype.getSubscriptionToCollapseNode=function(){var e=this;return this.actions$.ofType(T.TREE_COLLAPSE_NODE).pipe(r.filter(function(t){return e.isExpanded&&t.payload.treeId===e.treeModel.treeId&&e.node.id===t.payload.id})).subscribe(function(){e.markNodeAsCollapsed()})},e.prototype.initEditModeIfNeeded=function(e){e&&(this.isEditMode=e.id===I,this.isEditMode&&(this.nameField.setValue(""),this.setFocus()))},e.decorators=[{type:t.Component,args:[{encapsulation:t.ViewEncapsulation.None,selector:"ri-tree-item",template:'\n    <div class="tree-item"\n         [ngClass]="{\'tree-item-selected\': isSelected}"\n         (contextmenu)="onContextMenu($event)"\n         riDroppable\n         riDraggable\n         [dragZone]="treeModel.configuration.dragZone"\n         [dropConfig]="{dropAllowedCssClass: \'drop-allowed\', dropZone: treeModel.configuration.dropZone}"\n         [data]="node"\n         id="node-{{node.id}}"\n    >\n      <i *ngIf="!isExpanded" (click)="expand()" class="fa fa-caret-right pointer"></i>\n      <i *ngIf="isExpanded" (click)="collapse()" class="fa fa-caret-down pointer"></i>\n      <span *ngIf="!isEditMode" class="tree-item-name" (click)="onSelect()">{{node.name}}</span>\n      <form name="form">\n        <input #inputElement type="text" class="form-control" *ngIf="isEditMode" [formControl]="nameField"\n               name="name" (keydown)="onChange($event)" (blur)="onBlur()"/>\n      </form>\n    </div>\n    <div class="tree" [@isExpanded]="animationState" (@isExpanded.done)="onAnimationDone($event)">\n      <div *ngIf="isExpanded">\n        <ri-tree-item *ngFor="let child of children$ | async" [node]="child" [treeModel]="treeModel"\n                      [contextMenu]="contextMenu"></ri-tree-item>\n      </div>\n    </div>\n  ',styles:["\n\n  "],animations:[j()]}]}],e.ctorParameters=function(){return[{type:$},{type:p.ContextMenuService},{type:c.Actions}]},e.propDecorators={input:[{type:t.ViewChild,args:["inputElement"]}],node:[{type:t.Input}],treeModel:[{type:t.Input}],contextMenu:[{type:t.Input}]},e}(),F=function(){function e(){this.dropStream$=new f.Subject,this.dragStream$=new h.BehaviorSubject(null),this.drop$=new o.Observable,this.drop$=this.dropStream$.withLatestFrom(this.dragStream$,function(e,t){return{dragNode:t,dropNode:e,type:t.type}})}return e.prototype.dragStart=function(e){this.dragStream$.next(e)},e.prototype.dragEnd=function(e){this.dropStream$.next(e)},e.prototype.getDragStream=function(){return this.dragStream$},e.prototype.getLastDragElement=function(){return this.dragStream$.getValue()},e.DROP_DATA_TYPE="TREE_NODE",e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[]},e}(),k=function(){function e(e,t,n){this.store=e,this.treeActions=t,this.dragAndDrop=n,this.defaultOptions=[{name:"onEdit",text:"RI_TREE_LBL_EDIT_NODE",iconCls:"fa fa-edit"},{name:"onDelete",text:"RI_TREE_LBL_REMOVE_NODE",iconCls:"fa fa-trash"}],this.menuList=[],this.subscription=new u.Subscription}return e.prototype.ngOnInit=function(){var e=this;this.registerMove(),this.rootNodes$=this.treeModel.rootNodes$,this.subscription.add(this.treeModel.currentSelectedNode$.subscribe(function(t){return e.currentSelectedNode=t}))},e.prototype.ngOnChanges=function(e){var t=this;this.menuList=[],this.defaultOptions.forEach(function(e){return t.menuList.push(e)})},e.prototype.onAdd=function(){var e=this.currentSelectedNode?this.currentSelectedNode.id:null;this.store.dispatch(this.treeActions.insertNode(this.treeModel.treeId,e))},e.prototype.onContextMenuClick=function(e,t){switch(e){case"onEdit":event.stopPropagation(),this.store.dispatch(this.treeActions.editNodeStart(t));break;case"onDelete":this.store.dispatch(this.treeActions.deleteNode(this.treeModel.treeId,t));break;default:console.warn("Unknown context menu action: "+e)}},e.prototype.registerMove=function(){var e=this;this.treeModel.configuration.disableMoveNodes||this.dragAndDrop.drop$.pipe(r.filter(function(t){return t.type===F.DROP_DATA_TYPE?t.dropNode?t.dropNode.data.treeId===e.treeModel.treeId:t.dragNode.data.treeId===e.treeModel.treeId:!t.dropNode||!t.dropNode.zones||-1!==t.dropNode.zones.indexOf(t.dragNode.zoneId)})).subscribe(function(t){var n=t.dropNode?t.dropNode.data:null;e.store.dispatch(e.treeActions.moveNode(t.type,e.treeModel.treeId,t.dragNode.data,n))})},e.decorators=[{type:t.Component,args:[{encapsulation:t.ViewEncapsulation.None,selector:"ri-tree",template:'\n    <div class="tree">\n      <button *ngIf="treeModel.configuration.showAddButton" class="btn btn-default add-node-button" (click)="onAdd()">\n        <i class="fa fa-plus"></i> {{\'RI_TREE_LBL_ADD_NODE\' | translate}}\n      </button>\n      \x3c!--@formatter:off--\x3e\n      <div #customTemplate><ng-content></ng-content></div>\n      \x3c!--@formatter:on--\x3e\n      <div *ngIf="customTemplate.childNodes.length === 0">\n        <ri-tree-item\n          class="root-node"\n          *ngFor="let node of rootNodes$ | async"\n          [node]="node"\n          [treeModel]="treeModel"\n          [contextMenu]="contextMenu"></ri-tree-item>\n      </div>\n      <ri-dropzone [treeModel]="treeModel"></ri-dropzone>\n      <context-menu id="context-menu-{{treeModel.treeId}}" #contextMenu>\n        <ng-template *ngFor="let menuItem of menuList" contextMenuItem let-item\n                     (execute)="onContextMenuClick(menuItem.name, $event.item)">\n          <span class="{{menuItem.iconCls}}" style="width: 20px; display: inline-block;"></span>\n          {{menuItem.text | translate}}\n        </ng-template>\n      </context-menu>\n    </div>\n  ',styles:["\n    @iconWidth: 8px;\n    @colorHover: rgba(161, 197, 238, 0.2);\n    @colorSelected: #549dee;\n    @colorBorder: #4684ee;\n\n    .tree {\n      list-style-type: none;\n      margin: 0;\n      padding-left: 0;\n      position: relative;\n\n      .dropdown {\n        position: inherit;\n      }\n\n      .dropdown-menu {\n        position: absolute !important;\n      }\n\n      .pointer {\n        cursor: pointer;\n      }\n\n      .tree {\n        margin-left: 20px;\n      }\n\n      .tree-edit-btn, .tree-remove-btn {\n        display: none;\n      }\n\n      .tree-item {\n        padding: 2px 0;\n\n        &.drop-allowed {\n          .tree-item-name {\n            background-color: rgba(255, 0, 0, 0.3);\n          }\n        }\n\n        &.tree-item-selected {\n          > .tree-item-name {\n            padding: 0 1px;\n            border: 1px solid @colorBorder;\n            background-color: @colorSelected;\n          }\n        }\n\n        i {\n          width: @iconWidth !important;\n          text-align: center;\n        }\n\n        .no-children {\n          display: inline-block;\n          width: @iconWidth;\n        }\n\n        .tree-item-name {\n          display: inline-block;\n          line-height: 22px;\n          height: 22px;\n          padding: 0 2px;\n          cursor: pointer;\n\n          &:hover {\n            background-color: @colorHover;\n\n            .tree-edit-btn, .tree-remove-btn {\n              display: inline-block;\n            }\n          }\n        }\n\n        form {\n          display: inline-block;\n\n          input {\n            width: auto;\n          }\n        }\n      }\n    }\n  "]}]}],e.ctorParameters=function(){return[{type:n.Store},{type:T},{type:F}]},e.propDecorators={treeModel:[{type:t.Input}],contextMenu:[{type:t.ViewChild,args:["contextMenu"]}]},e}(),U=function(){function e(e,t,n){var o=this;this.el=e,this.renderer=t,this.dragAndDrop=n,this.dragZone=null,this.sourceType=F.DROP_DATA_TYPE,this.dragEnabled=!0,t.listen(e.nativeElement,"dragstart",function(e){o.dragEnabled&&o.onDragStart(e)}),t.listen(e.nativeElement,"dragend",function(){o.dragAndDrop.dragStart(null)})}return e.prototype.onDragStart=function(e){this.dragAndDrop.dragStart({zoneId:this.dragZone,data:this.data,type:this.sourceType}),e.dataTransfer.effectAllowed="copy",e.dataTransfer.dropEffect="copy"},e.prototype.ngOnInit=function(){if(this.el.nativeElement.draggable=this.dragEnabled,!this.data)throw new Error("DraggableDirective needs data")},e.decorators=[{type:t.Directive,args:[{selector:"[riDraggable]"}]}],e.ctorParameters=function(){return[{type:t.ElementRef},{type:t.Renderer},{type:F}]},e.propDecorators={data:[{type:t.Input}],dragZone:[{type:t.Input}],sourceType:[{type:t.Input}]},e}(),V=function(){function e(e,t,n){var o=this;this.el=e,this.renderer=t,this.dragAndDrop=n,this.dropConfig={},this.isDropAllowed=function(){var e=this.dragAndDrop.getLastDragElement(),t=e.data,n=this.data,o=this.dropConfig.dropZone;return!(o&&o.length>0&&-1===o.indexOf(e.zoneId))&&!(t===n||n.id===t.parentId||n.parents.indexOf(t.id)>-1)},t.listen(e.nativeElement,"dragover",function(e){e.preventDefault();var t=o.isDropAllowed();o.changeTargetCursor(e,t),o.toggleDropClass(t)}),t.listen(e.nativeElement,"dragleave",function(e){e.preventDefault(),o.toggleDropClass(!1)}),t.listen(e.nativeElement,"drop",function(){o.toggleDropClass(!1),o.isDropAllowed()&&o.dragAndDrop.dragEnd({zones:o.dropConfig.dropZone,data:o.data})})}return e.prototype.ngOnInit=function(){if(this.initConfig(),!this.data)throw new Error("DroppableDirective needs data")},e.prototype.toggleDropClass=function(e){void 0===e&&(e=!1),this.renderer.setElementClass(this.el.nativeElement,this.dropConfig.dropAllowedCssClass,e)},e.prototype.changeTargetCursor=function(e,t){void 0===t&&(t=!1);var n=t?"copy":"none";e.dataTransfer.effectAllowed=n,e.dataTransfer.dropEffect=n},e.prototype.initConfig=function(){var e={dropAllowedCssClass:"drop-allowed"};for(var t in e)e.hasOwnProperty(t)&&(this.dropConfig[t]=this.dropConfig[t]||e[t])},e.decorators=[{type:t.Directive,args:[{selector:"[riDroppable]"}]}],e.ctorParameters=function(){return[{type:t.ElementRef},{type:t.Renderer},{type:F}]},e.propDecorators={data:[{type:t.Input}],dropConfig:[{type:t.Input}]},e}(),B=function(){function e(e){var t=this;this.dragAndDrop=e,this.dropZone=[];var n=this.dragAndDrop.getDragStream().pipe(r.map(function(e){if(!!e&&!!e.data){if(e.type===F.DROP_DATA_TYPE){var n=e.data.parentId,o=e.data.treeId===t.treeModel.treeId;return!(!n||!o)}return!0}return!1})),i=this.dragAndDrop.drop$.pipe(r.map(function(e){return!1}));this.isOpen$=o.Observable.merge(n,i)}return e.prototype.onDrop=function(){this.dragAndDrop.dragEnd(null)},e.prototype.onDragOver=function(e){e.preventDefault()},e.decorators=[{type:t.Component,args:[{selector:"ri-dropzone",template:'\n    <div *ngIf="isOpen$ | async" (drop)="onDrop()" (dragover)="onDragOver($event)" class="dropzone">\n      {{\'RI_TREE_LBL_DROP_ZONE\' | translate}}\n    </div>\n  ',styles:["\n    .dropzone {\n      display: inline-block;\n      border: 1px dotted red;\n      padding: 10px;\n      background-color: rgba(255, 0, 0, 0.3);\n    }\n  "]}]}],e.ctorParameters=function(){return[{type:F}]},e.propDecorators={treeModel:[{type:t.Input}],dropZone:[{type:t.Input}]},e}(),q=new t.InjectionToken("NODE_SERVICE"),Z=function(){function e(e){this.http=e,this.apiConfig={addUrl:"/api/nodes",getUrl:"/api/nodes",moveUrl:"/api/nodes/move",updateUrl:"/api/nodes",removeUrl:"/api/nodes"}}return Object.defineProperty(e.prototype,"treeId",{get:function(){return"tree"},enumerable:!0,configurable:!0}),e.prototype.setAllNodes=function(e){},e.prototype.load=function(e){void 0===e&&(e="");var t=(new _.HttpParams).set("nodeId",e);return this.http.get(this.getPath("GET",e),{params:t})},e.prototype.add=function(e,t){return void 0===t&&(t=null),this.http.post(this.getPath("CREATE",t),{node:e,parentNodeId:t})},e.prototype.move=function(e,t){var n=e.id,o=t?t.id:null;return this.http.put(this.getPath("MOVE",n,o),{source:n,target:o})},e.prototype.update=function(e){return this.http.put(this.getPath("UPDATE",e.id),e)},e.prototype.remove=function(e){var t=(new _.HttpParams).set("nodeId",e);return this.http.delete(this.getPath("REMOVE",e),{params:t})},e.prototype.getPath=function(e,t,n){if(void 0===n&&(n=null),!this.apiConfig)throw new Error("No API configuration for Tree");var o={GET:this.apiConfig.getUrl,CREATE:this.apiConfig.addUrl,REMOVE:this.apiConfig.removeUrl,UPDATE:this.apiConfig.updateUrl,MOVE:this.apiConfig.moveUrl},r=this.replaceNodeId(o[e],t);return n&&(r=this.replaceDestNodeId(r,n)),r},e.prototype.replaceNodeId=function(e,t){return e.replace("{nodeId}",t)},e.prototype.replaceDestNodeId=function(e,t){return e.replace("{destNodeId}",t)},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:_.HttpClient}]},e}(),z=function(){function e(e){this.nodeService=e}return e.prototype.get=function(e){var t=this.nodeService.find(function(t){return t.treeId===e});return Boolean(t)?t:this.nodeService[0]},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:Array,decorators:[{type:t.Inject,args:[q]}]}]},e}(),G=this&&this.__assign||Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},H=this&&this.__decorate||function(e,t,n,o){var r,i=arguments.length,a=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,o);else for(var d=e.length-1;d>=0;d--)(r=e[d])&&(a=(i<3?r(a):i>3?r(t,n,a):r(t,n))||a);return i>3&&a&&Object.defineProperty(t,n,a),a},Y=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},X=function(){function e(e,t,n,i){var a=this;this.actions$=e,this.treeActions=t,this.nodeDispatcherService=n,this.store=i,this.register$=this.actions$.ofType(T.TREE_REGISTER).pipe(r.map(function(e){return e.payload.silent?a.treeActions.setAllNodes(e.payload.treeId,e.payload.nodes):a.treeActions.loadTree(e.payload.treeId,null)})),this.load$=this.actions$.ofType(T.TREE_LOAD).pipe(r.mergeMap(function(e){return a.loadNodes(e.payload.treeId,e.payload.id).pipe(r.map(function(t){return a.treeActions.loadTreeSuccess(e.payload.treeId,e.payload.id,t)}),r.catchError(function(){return o.Observable.of(a.treeActions.loadTreeError(e.payload.treeId,e.payload.id))}))})),this.delete$=this.actions$.ofType(T.TREE_DELETE_NODE).pipe(r.switchMap(function(e){return a.deleteNode(e.payload.treeId,e.payload.node).pipe(r.map(function(){return a.treeActions.deleteNodeSuccess(e.payload.treeId,e.payload.node)}),r.catchError(function(){return o.Observable.of(a.treeActions.deleteNodeError(e.payload.treeId,e.payload.node))}))})),this.save$=this.actions$.ofType(T.TREE_SAVE_NODE).pipe(r.switchMap(function(e){return a.saveNode(e.payload.treeId,G({},e.payload.node)).pipe(r.map(function(t){return a.treeActions.saveNodeSuccess(e.payload.treeId,e.payload.node,t)}),r.catchError(function(){return o.Observable.of(a.treeActions.saveNodeError(e.payload.treeId,e.payload.node))}))})),this.move$=this.actions$.ofType(T.TREE_MOVE_NODE).pipe(r.filter(function(e){return e.payload.sourceOfDroppedData===F.DROP_DATA_TYPE}),r.switchMap(function(e){var t=G({},e.payload.oldNode),n=Boolean(e.payload.node)?G({},e.payload.node):null;return a.moveNode(e.payload.treeId,t,n).pipe(r.map(function(t){return{treeId:e.payload.treeId,oldNode:e.payload.oldNode,node:t}}),r.switchMap(function(t){return a.store.select(x(e.payload.treeId)).pipe(r.take(1),r.map(function(e){return{configuration:e,data:t}}))}),r.catchError(function(){return a.treeActions.moveNodeError(e.payload.treeId,e.payload.oldNode,e.payload.node),o.Observable.of(e.payload)}))}),r.mergeMap(function(e){var t=e.data,n=[a.treeActions.moveNodeSuccess(t.treeId,t.oldNode,t.node)];return e.configuration.isFullyLoaded||n.push(a.treeActions.loadTree(t.treeId,t.node.parentId)),n})),this.insert$=this.actions$.ofType(T.TREE_INSERT_NODE).pipe(r.map(function(e){return a.treeActions.expandNode(e.payload.treeId,e.payload.id)})),this.initPathForFullyLoadedTreeEffect$=this.actions$.ofType(T.TREE_LOAD_PATH).pipe(r.switchMap(function(e){return a.store.select(x(e.payload.treeId)).pipe(r.take(1),r.map(function(t){return{action:e,configuration:t}}))}),r.map(function(e){var t=e.action;if(e.configuration.isFullyLoaded)return t.payload.ids.map(function(e){return a.treeActions.expandNode(t.payload.treeId,e)});var n=t.payload.ids.map(function(e){return a.loadNodes(t.payload.treeId,e)});return o.Observable.combineLatest(n).pipe(r.take(1),r.mergeMap(function(e){var n=e.map(function(e,n){return a.treeActions.loadTreeSuccess(t.payload.treeId,t.payload.ids[n],e)}),o=t.payload.ids.map(function(e){return a.treeActions.expandNode(t.payload.treeId,e)});return n.concat(o)}))}),r.mergeMap(function(e){return e}))}return e.prototype.deleteNode=function(e,t){var n=this.nodeDispatcherService.get(e);return t.id?n.remove(t.id):o.Observable.of(t)},e.prototype.loadNodes=function(e,t){return this.nodeDispatcherService.get(e).load(t)},e.prototype.saveNode=function(e,t){var n=this.nodeDispatcherService.get(e);return t.id===I?n.add(t,t.parentId):n.update(t)},e.prototype.moveNode=function(e,t,n){return this.nodeDispatcherService.get(e).move(t,n)},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:c.Actions},{type:T},{type:z},{type:n.Store}]},H([c.Effect(),Y("design:type",Object)],e.prototype,"register$",void 0),H([c.Effect(),Y("design:type",Object)],e.prototype,"load$",void 0),H([c.Effect(),Y("design:type",Object)],e.prototype,"delete$",void 0),H([c.Effect(),Y("design:type",Object)],e.prototype,"save$",void 0),H([c.Effect(),Y("design:type",Object)],e.prototype,"move$",void 0),H([c.Effect(),Y("design:type",Object)],e.prototype,"insert$",void 0),H([c.Effect(),Y("design:type",Object)],e.prototype,"initPathForFullyLoadedTreeEffect$",void 0),e}(),K=function(){function e(e,t,n){this.nodeDispatcherService=e,this.treeActionsDispatcher=t,this.store=n}return e.prototype.createTreeModel=function(e,t){void 0===t&&(t=null);var n=e.treeId,o=Boolean(t);this.treeActionsDispatcher.registerTree(n,o,t),this.treeActionsDispatcher.setConfiguration(n,e),Boolean(t)&&(this.nodeDispatcherService.get(n).setAllNodes(t),this.treeActionsDispatcher.markAsFullyLoaded(n));var r=this.store.select(M(e.treeId));return new P(this.treeActionsDispatcher,r,e,o)},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:z},{type:$},{type:n.Store}]},e}(),W=function(){function e(e){this.nodeDispatcherService=e}return e.prototype.ngOnInit=function(){this.parents$=this.treeModel.getParentsList()},e.prototype.selectNode=function(e,t){t||this.nodeDispatcherService.selectNode(this.treeModel.treeId,e)},e.decorators=[{type:t.Component,args:[{selector:"ri-tree-parents-list",template:'\n    <ul class="ri-tree-parents-list">\n      <li class="fa fa-home" (click)="selectNode(null, false)"></li>\n      <li *ngFor="let node of parents$ | async; last as isLast" (click)="selectNode(node, isLast)">{{node.name}}\n      </li>\n    </ul>\n  ',styles:["\n    .ri-tree-parents-list {\n      list-style-type: none;\n      margin: 0;\n      padding: 0;\n\n      li {\n        display: inline-block;\n        cursor: pointer;\n        color: #777777;\n\n        &:last-child, &:first-child, &:after {\n          color: #000000;\n        }\n\n        &:not(:last-child) {\n          &:after {\n            content: '/';\n            display: inline-block;\n            width: 10px;\n            text-align: center;\n          }\n        }\n      }\n    }\n  "]}]}],e.ctorParameters=function(){return[{type:$}]},e.propDecorators={treeModel:[{type:t.Input}]},e}(),J=function(){function e(e){this.translate=e,this.setTranslationForEN(),this.setTranslationForPL(),this.translate.use("en")}return e.forRoot=function(t){return{ngModule:e,providers:[F,z,$,T,X,K,{provide:q,useClass:t,multi:!0}]}},e.forFeature=function(t){return{ngModule:e,providers:[F,z,$,T,X,K,{provide:q,useClass:t,multi:!0}]}},e.prototype.setTranslationForPL=function(){this.translate.setTranslation("pl",{RI_TREE_LBL_ADD_NODE:"Dodaj",RI_TREE_LBL_EDIT_NODE:"Edytuj",RI_TREE_LBL_REMOVE_NODE:"Usuń",RI_TREE_LBL_DROP_ZONE:"Upuść tutaj"})},e.prototype.setTranslationForEN=function(){this.translate.setTranslation("en",{RI_TREE_LBL_ADD_NODE:"Add data",RI_TREE_LBL_EDIT_NODE:"Edit data",RI_TREE_LBL_REMOVE_NODE:"Delete data",RI_TREE_LBL_DROP_ZONE:"Drop here to move data to root level"})},e.decorators=[{type:t.NgModule,args:[{imports:[N.CommonModule,p.ContextMenuModule,D.DndModule,c.EffectsModule.forFeature([X]),_.HttpClientModule,s.FormsModule,s.ReactiveFormsModule,n.StoreModule.forFeature("trees",b),v.TranslateModule],declarations:[k,w,U,V,B,W],exports:[k,w,U,V,B,D.DraggableComponent,W,n.StoreModule,c.EffectsModule],providers:[{provide:q,useClass:Z,multi:!0}],schemas:[t.CUSTOM_ELEMENTS_SCHEMA]}]}],e.ctorParameters=function(){return[{type:v.TranslateService}]},e}();e.TreeModule=J,e.TreeComponent=k,e.expand=j,e.ItemComponent=w,e.TreeModel=P,e.NODE_SERVICE=q,e.NodeService=Z,e.ParentsListComponent=W,e.NodeDispatcherService=z,e.TreeModelGeneratorService=K,e.TreeActionsService=T,e.TreeActionsDispatcherService=$,e.TreeEffectsService=X,e.NEW_NODE_ID=I,e.emptyTreeData=R,e.treeReducer=b,e.treeStateSelector=C,e.treeSelector=M,e.treeConfigurationSelector=x,e.DragAndDrop=F,e.DraggableDirective=U,e.DroppableDirective=V,e.DropzoneComponent=B,Object.defineProperty(e,"__esModule",{value:!0})});